## Redis——数据结构与对象

<img src="https://wx4.sinaimg.cn/mw1024/9c96fc9cly1g7hlih7twrj20tg0cp75i.jpg" referrerpolicy="no-referrer">

### 简单动态字符串（SDS）
Redis自己创建了一种名为简单字符串的抽象类型(simple dynamic string)，作为Redis默认的字符串表示。
#### SDS结构
```c
struct sdshdr {

    // 记录buf数据中已使用字节的数量
    // 等于SDS所保存字符串的长度
    int len;

    // 记录buf数据宗伟使用的字节数量
    int free;

    // 字节数组，用来保存字符串
    char buf[];
}
```
#### SDS与C字符串的区别
- 获取C字符串长度需要遍历整个字符串，复杂度为O(N)，SDS只需要读取len属性，复杂度O(1)
- 杜绝缓冲区溢出，C字符串使用`strcat`拼接字符串时，如果没有分配足够的内存，容易造成缓冲区溢出，SDS在`sdscat`函数执行时会先检查是否有足够空间。
- 减少修改字符串时带来的内存重新分配次数，当C字符串进行缩短操作时，会立刻释放多余内存，后续进行拼接时又需要重新分配扩展，SDS在缩短后不会立刻释放内存，采用**空间预分配**和**惰性空间释放**的策略来避免内存空间频繁改动。
- 保障二进制安全，C字符串必须符合某种编码，并且除了字符串末尾，不能含有空字符，否则会被误认为是字符串的结尾，使得C字符串只能保存文本，而不能保存图片、音视频等二进制数据。SDS的buf数组可以保存二进制数据，是二进制安全的。
- SDS兼容部分C字符串函数，SDS遵循C字符串末尾是`\0`空字符的惯例，因此可以使用一部分`<string.h>`库定义的函数。

### 链表
#### 链表结构
链表节点：
```c
typedef struct listNode {

    // 前置节点
    struct listNode *prev;

    // 后置节点
    struct listNode *next;

    // 节点的值
    void *value;

} listNode;
```

链表：
```c
typedef struct list {

    // 表头节点
    listNode *head;

    // 表尾结点
    listNode *tail;

    // 链表所包含的节点数量
    unsigned long len;

    // 节点值复制函数
    void *(*dup) (void *ptr);

    // 节点值释放函数
    void *(*free) (void *ptr);

    // 节点值对比函数
    void *(*match) (void *ptr, void *key);

    
} list
```

#### 链表特性

- 双端
- 无环，表头节点的prev指针和表尾结点的next指针都指向`null`，对链表的访问以`null`为终点
- 带头指针和尾指针
- 带链表长度计数器
- 多态，节点使用`void*`指针来保存节点值，可以用于保存各种不同类型的值。

### 字典
字典的实现使用哈希表作为底层结构，一个哈希表里可以有多个哈希表节点，每个哈希表节点保存一个字典中的键值对。

##### 哈希表的定义
```c
typedef struct dictht {

    // 哈希表数组
    dictEntry **table;

    // 哈希表大小
    unsigned long size;

    // 哈希表大小掩码，用于计算索引，总是等于size-1
    unsigned long sizemask;

    // 哈希表已有节点的数量
    unsigned long used;

} dictht
```
##### 哈希表节点定义
```c
typedef struct dictEntry {

    // 键
    void *key;

    // 值
    union {
        void *val;
        uint64_t u64;
        int64_t s64;
    } v

    // 指向下一个哈希表节点，形成链表
    struct dictEntry *next;

} dictht
```

### 跳跃表

### 整数集合

### 压缩列表

### 对象