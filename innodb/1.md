## MySQL技术内幕innodb存储引擎读书笔记

### 1 Innodb关键特性
- change buffer

可以看做是Insert buffer升级版，当需要插入或更新一个数据页时，对于非聚簇索引，如果该数据页不在内存当中，Innodb在不影响一致性的前提下，会将更新操作缓存在change buffer中，可以省去从磁盘读取该页的操作，在以一定的频率和情况下与索引页进行merge合并，这时通常可以把多个更新页的操作合并为一次磁盘读写，这样就大大提高了插入性能。

#### 什么条件下可以使用change buffer？

对于唯一索引，所有的插入和更新操作都要判断其唯一性，要判断就需要把数据页加载到内存当中，这是可以直接更新，自然也就不需要用change buffer，因此，`只有非唯一的二级索引可以使用change buffer`。

> 虽然名字是buffer，但change buffer不仅有内存副本，也是会写入磁盘空间的。

- double write
  
二次写，通俗的说，就是为了防止在写入的过程中发生部分写失败(partial page write)而造成的数据丢失，所以在写数据页之前，先将数据写入共享表空间(ibdata)，然后再写数据页，如果出现数据页损坏，可以通过该页的副本来还原该页，然后在进行redo log重做，这个机制就叫做double write。

> double write 由两部分组成，一部分是内存中2M的doublewrite buffer，另一部分是磁盘上共享表空间中连续的128个页（两个区）也是2M。执行顺序是 加载脏页信息到double write buffer中->分两次，每次1M写入共享表空间->调用fsync同步磁盘。

- 自适应哈希索引

Innodb的索引是B+树，如果树高为3-4层，那么就需要3-4次io操作来进行检索，而Hash查找的时间复杂度为O(1)，即一般只进行一次查询就能定位数据。Innodb会对表上的索引进行监控，如果发现建立哈希索引可以提升性能，则会为这些热点页建立哈希索引。

> 自适应哈希索引不需要开发人员或者DBA介入，完全由Innodb自动调整。对建立的页有一个要求，就是连续一定次数访问模式必须是一样的，如果是联合索引的不同使用方式，则不能触发自适应哈希索引。`例如a,b的联合索引，按a查询和按a,b查询视为不同使用方式，虽然使用的都是同一索引。`

- 刷新相邻页

Innodb在刷新一个脏页时，会检测该页所在区的所有页，如果是脏页，则会一起进行刷盘。这样的好处是可以合并IO操作，提高性能。

> 缺点是会将不怎么脏的页一起刷入，但是这些页可能很快又会变脏，所以机械硬盘更需要这个特性，固态硬盘的IOPS超高，建议关闭此特性。

