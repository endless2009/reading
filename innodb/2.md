## MySQL技术内幕innodb存储引擎读书笔记
### Innodb的索引

#### 1. B+树和索引
B+树是一种平衡多路树，所有的记录节点都会按键值大小的顺序存放在同一层的叶子节点上，各叶子节点中用指针形成双向链表(实际上链表是基于页)。

B+树一般被作为索引使用，分为`聚簇索引`和`二级索引`，聚簇索引一般可以认为是主键索引，二级索引是普通索引。
- 聚簇索引：非叶子节点保存主键值，叶子节点保存整张表的行记录，也把聚簇索引的叶子节点称为数据页。 
- 二级索引：非叶子节点保存索引值，叶子节点保存主键值。

> 主键索引尽量使用自增ID，占用空间小，可以在一个页中保存更多的主键记录，减少B+树层次，减少IO查询次数。

> 如果二级索引中包含全部需要返回的列，则被称为覆盖索引。例如`select age from table where age = 27`其中age字段包含二级索引。

> 使用二级索引查询时，在索引树上查询到主键ID，还需要在聚簇索引的索引树上再次查询获取数据页，这个行为被称为`回表`，如果是覆盖索引查询的话，则可以省略回表的过程，从而提高性能。

> 索引属性`Cardinality`，代表了这个索引上不重复值的数量，实际应用中，`Cardinality`应该尽可能的接近于行数，如果这个值太小，说明索引字段的值重复的非常多，考虑是否可以去掉该索引。

> `Cardinality`的统计是一个取样估计值而非准确值(随机取八个叶子节点，所包含的记录数量平均值乘以叶子节点总数)，如果差别很多，可以使用`analysis table`命令进行更新。

> 联合索引按照由左到右顺序进行匹配

#### 2. 索引的优化
##### Multi-Range Read优化

MMR优化目的是为了减少磁盘的随机访问。在查询二级索引时，先对查询到的结果按照主键进行排序，再去聚簇索引进行回表。

> MMR优化还会对范围查询进行拆分，并且会在执行计划中的Extra列显示`Using MMR`(P224)

##### Index Condition Pushdown优化

ICP优化在进行索引查询，在取出索引的同时，判断是否能进行where条件过滤，换一种说法就是讲where部分放到了存储引擎层。之前的MySQL版本(5.6之前)需要首先根据索引查出记录，再进行where过滤。

> 当使用ICP优化是，执行计划中列Extra看到`Using index condition`提示。